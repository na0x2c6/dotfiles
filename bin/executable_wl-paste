#!/bin/bash

if [ -z "$HOST_OS" ]; then
  HOST_OS="$(_exec-host uname -s 2>/dev/null < /dev/null | tr '[:upper:]' '[:lower:]')"
  export HOST_OS
fi

# Forward to wl-paste directly on Linux host
if [[ "$HOST_OS" == "linux" ]]; then
    _exec-host wl-paste "$@"
    exit $?
fi

# macOS: emulate wl-paste with pbpaste
NO_NEWLINE=false
LIST_TYPES=false
WATCH_CMD=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -n|--no-newline)
            NO_NEWLINE=true
            shift
            ;;
        -l|--list-types)
            LIST_TYPES=true
            shift
            ;;
        -w|--watch)
            shift
            WATCH_CMD=("$@")
            break
            ;;
        -p|--primary|-s|--seat|-t|--type)
            case "$1" in
                -s|--seat|-t|--type) shift 2 ;;
                *) shift ;;
            esac
            ;;
        -h|--help|-v|--version)
            shift
            ;;
        --)
            shift
            break
            ;;
        -*)
            shift
            ;;
        *)
            break
            ;;
    esac
done

if $LIST_TYPES; then
    # pbpaste does not support MIME types
    echo "text/plain"
    exit 0
fi

if [[ ${#WATCH_CMD[@]} -gt 0 ]]; then
    echo "wl-paste: --watch is not supported in this wrapper" >&2
    exit 1
fi

if $NO_NEWLINE; then
    _exec-host pbpaste | tr -d '\n'
else
    _exec-host pbpaste
fi
